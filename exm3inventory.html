<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manajemen Inventori Pertanian</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/_sdk/element_sdk.js"></script>
    <style>
      body {
        box-sizing: border-box;
      }

      .notification-slide {
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .fade-out {
        animation: fadeOut 0.3s ease-out forwards;
      }

      @keyframes fadeOut {
        from {
          opacity: 1;
          transform: translateX(0);
        }
        to {
          opacity: 0;
          transform: translateX(100%);
        }
      }
    </style>
    <style>
      @view-transition {
        navigation: auto;
      }
    </style>
    <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  </head>
  <body class="min-h-full">
    <div id="app" class="min-h-full p-6">
      <!-- Header -->
      <header class="mb-8">
        <div class="text-center">
          <h1
            id="dashboard-title"
            class="text-4xl font-bold text-green-800 mb-2"
          >
            Manajemen Inventori Pertanian
          </h1>
          <p id="farm-name" class="text-xl text-green-600">ILZ Business</p>
        </div>
      </header>
      <!-- Summary Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div
          class="bg-white rounded-lg shadow-md p-6 border-l-4 border-green-500"
        >
          <div class="flex items-center">
            <div class="text-green-600 text-2xl mr-4">üì¶</div>
            <div>
              <p class="text-sm font-medium text-gray-600">Total Barang</p>
              <p id="total-items" class="text-2xl font-bold text-gray-900">0</p>
            </div>
          </div>
        </div>
        <div
          class="bg-white rounded-lg shadow-md p-6 border-l-4 border-green-500"
        >
          <div class="flex items-center">
            <div class="text-green-600 text-2xl mr-4">‚úÖ</div>
            <div>
              <p class="text-sm font-medium text-gray-600">Stok Aman</p>
              <p id="safe-items" class="text-2xl font-bold text-green-600">0</p>
            </div>
          </div>
        </div>
        <div
          class="bg-white rounded-lg shadow-md p-6 border-l-4 border-yellow-500"
        >
          <div class="flex items-center">
            <div class="text-yellow-600 text-2xl mr-4">‚ö†Ô∏è</div>
            <div>
              <p class="text-sm font-medium text-gray-600">Stok Menipis</p>
              <p id="low-items" class="text-2xl font-bold text-yellow-600">0</p>
            </div>
          </div>
        </div>
        <div
          class="bg-white rounded-lg shadow-md p-6 border-l-4 border-red-500"
        >
          <div class="flex items-center">
            <div class="text-red-600 text-2xl mr-4">üö®</div>
            <div>
              <p class="text-sm font-medium text-gray-600">Stok Habis</p>
              <p id="empty-items" class="text-2xl font-bold text-red-600">0</p>
            </div>
          </div>
        </div>
      </div>
      <!-- Controls -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex flex-col md:flex-row gap-4 items-start md:items-end">
          <div class="flex-1">
            <label
              for="commodity-filter"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Filter Komoditas</label
            >
            <select
              id="commodity-filter"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
            >
              <option value="">Semua Komoditas</option>
            </select>
          </div>
        </div>
      </div>
      <!-- Inventory Table -->
      <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-xl font-semibold text-gray-800">Daftar Inventori</h2>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Nama Barang
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Jumlah
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Satuan
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Komoditas
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Status
                </th>
              </tr>
            </thead>
            <tbody
              id="inventory-table"
              class="bg-white divide-y divide-gray-200"
            >
              <tr id="empty-state" style="display: none">
                <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                  <div class="text-6xl mb-4">üì¶</div>
                  <p class="text-lg">Tidak ada data untuk filter ini</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <!-- Notifications Container -->
      <div id="notifications" class="fixed top-4 right-4 z-50 space-y-2"></div>
    </div>
    <script>
      // Configuration
      const defaultConfig = {
        dashboard_title: "Manajemen Inventori Pertanian",
        farm_name: "Kebun Makmur",
        notification_text: "Ada barang yang perlu diperhatikan!",
        primary_color: "#16a34a",
        surface_color: "#ffffff",
        text_color: "#1f2937",
        warning_color: "#eab308",
        danger_color: "#dc2626",
      };

      // Sample inventory data
      const inventory = [
        {
          id: "1",
          nama: "Pupuk Urea",
          jumlah: 25,
          satuan: "kg",
          komoditas: "Timun",
          stok_minimum: 50,
        },
        {
          id: "2",
          nama: "Selang Air",
          jumlah: 5,
          satuan: "unit",
          komoditas: "Bawang Merah",
          stok_minimum: 3,
        },
        {
          id: "3",
          nama: "Benih Cabai",
          jumlah: 0,
          satuan: "kg",
          komoditas: "Cabai",
          stok_minimum: 2,
        },
        {
          id: "4",
          nama: "Pestisida Organik",
          jumlah: 8,
          satuan: "liter",
          komoditas: "Timun",
          stok_minimum: 10,
        },
        {
          id: "5",
          nama: "Cangkul",
          jumlah: 12,
          satuan: "unit",
          komoditas: "Bawang Merah",
          stok_minimum: 5,
        },
        {
          id: "6",
          nama: "Pupuk Kompos",
          jumlah: 150,
          satuan: "karung",
          komoditas: "Cabai",
          stok_minimum: 20,
        },
        {
          id: "7",
          nama: "Sprayer Manual",
          jumlah: 3,
          satuan: "unit",
          komoditas: "Timun",
          stok_minimum: 2,
        },
        {
          id: "8",
          nama: "Mulsa Plastik",
          jumlah: 45,
          satuan: "meter",
          komoditas: "Bawang Merah",
          stok_minimum: 100,
        },
        {
          id: "9",
          nama: "Pupuk NPK",
          jumlah: 2,
          satuan: "karung",
          komoditas: "Cabai",
          stok_minimum: 15,
        },
        {
          id: "10",
          nama: "Sekop Kecil",
          jumlah: 8,
          satuan: "unit",
          komoditas: "Timun",
          stok_minimum: 4,
        },
        {
          id: "11",
          nama: "Fungisida",
          jumlah: 0,
          satuan: "botol",
          komoditas: "Bawang Merah",
          stok_minimum: 5,
        },
        {
          id: "12",
          nama: "Tali Rafia",
          jumlah: 25,
          satuan: "unit",
          komoditas: "Cabai",
          stok_minimum: 10,
        },
      ];

      let notificationTimeout = null;

      // Element SDK configuration
      const elementConfig = {
        defaultConfig,
        onConfigChange: async (config) => {
          document.getElementById("dashboard-title").textContent =
            config.dashboard_title || defaultConfig.dashboard_title;
          document.getElementById("farm-name").textContent =
            config.farm_name || defaultConfig.farm_name;

          // Apply colors
          const primaryColor =
            config.primary_color || defaultConfig.primary_color;
          const surfaceColor =
            config.surface_color || defaultConfig.surface_color;
          const textColor = config.text_color || defaultConfig.text_color;
          const warningColor =
            config.warning_color || defaultConfig.warning_color;
          const dangerColor = config.danger_color || defaultConfig.danger_color;

          document.documentElement.style.setProperty(
            "--primary-color",
            primaryColor
          );
          document.documentElement.style.setProperty(
            "--surface-color",
            surfaceColor
          );
          document.documentElement.style.setProperty("--text-color", textColor);
          document.documentElement.style.setProperty(
            "--warning-color",
            warningColor
          );
          document.documentElement.style.setProperty(
            "--danger-color",
            dangerColor
          );
        },
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.primary_color || defaultConfig.primary_color,
              set: (value) => {
                if (window.elementSdk) {
                  window.elementSdk.setConfig({ primary_color: value });
                }
              },
            },
            {
              get: () => config.surface_color || defaultConfig.surface_color,
              set: (value) => {
                if (window.elementSdk) {
                  window.elementSdk.setConfig({ surface_color: value });
                }
              },
            },
            {
              get: () => config.text_color || defaultConfig.text_color,
              set: (value) => {
                if (window.elementSdk) {
                  window.elementSdk.setConfig({ text_color: value });
                }
              },
            },
            {
              get: () => config.warning_color || defaultConfig.warning_color,
              set: (value) => {
                if (window.elementSdk) {
                  window.elementSdk.setConfig({ warning_color: value });
                }
              },
            },
            {
              get: () => config.danger_color || defaultConfig.danger_color,
              set: (value) => {
                if (window.elementSdk) {
                  window.elementSdk.setConfig({ danger_color: value });
                }
              },
            },
          ],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined,
        }),
        mapToEditPanelValues: (config) =>
          new Map([
            [
              "dashboard_title",
              config.dashboard_title || defaultConfig.dashboard_title,
            ],
            ["farm_name", config.farm_name || defaultConfig.farm_name],
            [
              "notification_text",
              config.notification_text || defaultConfig.notification_text,
            ],
          ]),
      };

      // Initialize app
      function initializeApp() {
        try {
          if (window.elementSdk) {
            window.elementSdk.init(elementConfig);
          }

          // Initialize UI with sample data
          updateUI();
          updateSummary();
          updateCommodityFilter();
          checkStockLevels();
        } catch (error) {
          console.error("Failed to initialize app:", error);
        }
      }

      // Utility functions
      function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
      }

      function getStockStatus(current, minimum) {
        const percentage =
          minimum > 0 ? (current / minimum) * 100 : current > 0 ? 100 : 0;

        if (current === 0)
          return {
            status: "Habis",
            class: "bg-red-100 text-red-800",
            color: "red",
          };
        if (percentage <= 100)
          return {
            status: "Menipis",
            class: "bg-yellow-100 text-yellow-800",
            color: "yellow",
          };
        return {
          status: "Aman",
          class: "bg-green-100 text-green-800",
          color: "green",
        };
      }

      function showNotification(message, type = "warning") {
        const notification = document.createElement("div");
        notification.className = `notification-slide bg-white border-l-4 ${
          type === "error" ? "border-red-500" : "border-yellow-500"
        } p-4 rounded-lg shadow-lg max-w-sm`;

        notification.innerHTML = `
                <div class="flex items-center">
                    <div class="text-2xl mr-3">${
                      type === "error" ? "üö®" : "‚ö†Ô∏è"
                    }</div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-800">${message}</p>
                    </div>
                    <button class="ml-2 text-gray-400 hover:text-gray-600" onclick="this.parentElement.parentElement.remove()">
                        <span class="text-lg">√ó</span>
                    </button>
                </div>
            `;

        document.getElementById("notifications").appendChild(notification);

        setTimeout(() => {
          if (notification.parentElement) {
            notification.classList.add("fade-out");
            setTimeout(() => notification.remove(), 300);
          }
        }, 5000);
      }

      function updateSummary() {
        const total = inventory.length;
        let safe = 0,
          low = 0,
          empty = 0;

        inventory.forEach((item) => {
          const stockInfo = getStockStatus(item.jumlah, item.stok_minimum);
          if (stockInfo.status === "Aman") safe++;
          else if (stockInfo.status === "Menipis") low++;
          else empty++;
        });

        document.getElementById("total-items").textContent = total;
        document.getElementById("safe-items").textContent = safe;
        document.getElementById("low-items").textContent = low;
        document.getElementById("empty-items").textContent = empty;
      }

      function updateCommodityFilter() {
        const filter = document.getElementById("commodity-filter");
        const currentValue = filter.value;
        const commodities = [
          ...new Set(inventory.map((item) => item.komoditas)),
        ].sort();

        filter.innerHTML = '<option value="">Semua Komoditas</option>';
        commodities.forEach((commodity) => {
          const option = document.createElement("option");
          option.value = commodity;
          option.textContent = commodity;
          filter.appendChild(option);
        });

        filter.value = currentValue;
      }

      function updateUI() {
        const tableBody = document.getElementById("inventory-table");
        const emptyState = document.getElementById("empty-state");
        const filter = document.getElementById("commodity-filter").value;

        const filteredInventory = filter
          ? inventory.filter((item) => item.komoditas === filter)
          : inventory;

        if (filteredInventory.length === 0) {
          emptyState.style.display = "table-row";
          // Remove existing rows
          const existingRows = tableBody.querySelectorAll(
            "tr:not(#empty-state)"
          );
          existingRows.forEach((row) => row.remove());
          return;
        }

        emptyState.style.display = "none";

        // Update existing rows and add new ones
        const existingRows = new Map();
        tableBody.querySelectorAll("tr[data-item-id]").forEach((row) => {
          existingRows.set(row.dataset.itemId, row);
        });

        filteredInventory.forEach((item) => {
          const stockInfo = getStockStatus(item.jumlah, item.stok_minimum);

          if (existingRows.has(item.id)) {
            // Update existing row
            const row = existingRows.get(item.id);
            updateRowContent(row, item, stockInfo);
            existingRows.delete(item.id);
          } else {
            // Create new row
            const row = createTableRow(item, stockInfo);
            tableBody.appendChild(row);
          }
        });

        // Remove rows that are no longer needed
        existingRows.forEach((row) => row.remove());
      }

      function updateRowContent(row, item, stockInfo) {
        row.children[0].textContent = item.nama;
        row.children[1].textContent = item.jumlah;
        row.children[2].textContent = item.satuan;
        row.children[3].textContent = item.komoditas;

        const statusCell = row.children[4];
        statusCell.innerHTML = `<span class="px-2 py-1 text-xs font-semibold rounded-full ${stockInfo.class}">${stockInfo.status}</span>`;
      }

      function createTableRow(item, stockInfo) {
        const row = document.createElement("tr");
        row.dataset.itemId = item.id;
        row.className = "hover:bg-gray-50";

        row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.nama}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.jumlah}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.satuan}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.komoditas}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${stockInfo.class}">${stockInfo.status}</span>
                </td>
            `;

        return row;
      }

      function checkStockLevels() {
        if (notificationTimeout) {
          clearTimeout(notificationTimeout);
        }

        notificationTimeout = setTimeout(() => {
          const lowStockItems = inventory.filter((item) => {
            const stockInfo = getStockStatus(item.jumlah, item.stok_minimum);
            return (
              stockInfo.status === "Menipis" || stockInfo.status === "Habis"
            );
          });

          if (lowStockItems.length > 0) {
            const config = window.elementSdk?.config || defaultConfig;
            const message =
              config.notification_text || defaultConfig.notification_text;
            showNotification(`${message} (${lowStockItems.length} barang)`);
          }
        }, 1000);
      }

      // Event listeners
      document.addEventListener("DOMContentLoaded", () => {
        initializeApp();

        // Filter
        document
          .getElementById("commodity-filter")
          .addEventListener("change", updateUI);
      });
    </script>
    <script>
      (function () {
        function c() {
          var b = a.contentDocument || a.contentWindow.document;
          if (b) {
            var d = b.createElement("script");
            d.innerHTML =
              "window.__CF$cv$params={r:'998e34aab743a8f2',t:'MTc2MjE5NzM4My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
            b.getElementsByTagName("head")[0].appendChild(d);
          }
        }
        if (document.body) {
          var a = document.createElement("iframe");
          a.height = 1;
          a.width = 1;
          a.style.position = "absolute";
          a.style.top = 0;
          a.style.left = 0;
          a.style.border = "none";
          a.style.visibility = "hidden";
          document.body.appendChild(a);
          if ("loading" !== document.readyState) c();
          else if (window.addEventListener)
            document.addEventListener("DOMContentLoaded", c);
          else {
            var e = document.onreadystatechange || function () {};
            document.onreadystatechange = function (b) {
              e(b);
              "loading" !== document.readyState &&
                ((document.onreadystatechange = e), c());
            };
          }
        }
      })();
    </script>
  </body>
</html>

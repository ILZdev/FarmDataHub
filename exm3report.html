<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Laporan Data Akhir Pertanian</title>
    <script src="/_sdk/element_sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      @view-transition {
        navigation: auto;
      }
    </style>
    <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
    <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
  </head>
  <body>
    <div class="ReportContainer">
      <div class="ReportHeader">
        <h1 id="ReportDashboard-title">Laporan Data Akhir Pertanian</h1>
        <p id="ReportSubtitle">Dashboard Monitoring &amp; Analisis</p>
      </div>
      <div class="ReportFilters">
        <div class="ReportFilter-group">
          <label for="ReportKomoditas-filter">Filter Komoditas</label>
          <select id="ReportKomoditas-filter">
            <option value="semua">Semua Komoditas</option>
          </select>
        </div>
      </div>
      <div class="ReportStats-grid" id="ReportStats-grid"></div>
      <div class="table-ReportContainer">
        <div class="table-ReportHeader">
          <h2>Tabel Laporan Utama</h2>
        </div>
        <div class="ReportTable-wrapper">
          <table id="main-table">
            <thead>
              <tr>
                <th>Komoditas</th>
                <th>Total Biaya</th>
                <th>Total Hasil</th>
                <th>Laba/Rugi</th>
                <th>Efisiensi (%)</th>
                <th>Investor</th>
                <th>% Bagi Hasil</th>
                <th>Nilai Bagi Hasil</th>
              </tr>
            </thead>
            <tbody id="ReportTable-body"></tbody>
          </table>
        </div>
      </div>
      <div class="ReportCharts-grid">
        <div class="chart-ReportContainer">
          <h3>Perbandingan Biaya vs Hasil</h3>
          <div class="ReportChart-wrapper">
            <canvas id="ReportBar-chart"></canvas>
          </div>
        </div>
        <div class="chart-ReportContainer">
          <h3>Pembagian Laba Investor</h3>
          <div class="ReportChart-wrapper">
            <canvas id="ReportPie-chart"></canvas>
          </div>
        </div>
        <div class="chart-ReportContainer" style="grid-column: 1 / -1">
          <h3>Tren Laba Bersih per Komoditas</h3>
          <div class="ReportChart-wrapper">
            <canvas id="ReportLine-chart"></canvas>
          </div>
        </div>
      </div>
    </div>
    <script>
      // Inject CSS styles
      const styles = `
      body {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #f5f7fa 0%, #e8f5e9 100%);
        min-height: 100%;
      }

      * {
        box-sizing: border-box;
      }

      .ReportContainer {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
      }

      .ReportHeader {
        text-align: center;
        margin-bottom: 32px;
        padding: 24px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }

      .ReportHeader h1 {
        margin: 0 0 8px 0;
        font-size: 32px;
        font-weight: 700;
      }

      .ReportHeader p {
        margin: 0;
        font-size: 16px;
        opacity: 0.7;
      }

      .ReportFilters {
        display: flex;
        gap: 16px;
        margin-bottom: 24px;
        flex-wrap: wrap;
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }

      .ReportFilter-group {
        flex: 1;
        min-width: 200px;
      }

      .ReportFilter-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 14px;
      }

      .ReportFilter-group select {
        width: 100%;
        padding: 10px 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        background: white;
        cursor: pointer;
        transition: border-color 0.3s;
      }

      .ReportFilter-group select:focus {
        outline: none;
        border-color: #2E7D32;
      }

      .ReportStats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
      }

      .stat-card {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: transform 0.3s, box-shadow 0.3s;
      }

      .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      }

      .stat-card h3 {
        margin: 0 0 12px 0;
        font-size: 14px;
        font-weight: 600;
        opacity: 0.7;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .stat-card .value {
        font-size: 28px;
        font-weight: 700;
        margin: 0;
      }

      .stat-card.positive .value {
        color: #2E7D32;
      }

      .stat-card.negative .value {
        color: #d32f2f;
      }

      .stat-card.neutral .value {
        color: #FFA726;
      }

      .table-ReportContainer {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
        margin-bottom: 32px;
      }

      .table-ReportHeader {
        padding: 20px 24px;
        border-bottom: 2px solid #e0e0e0;
      }

      .table-ReportHeader h2 {
        margin: 0;
        font-size: 20px;
        font-weight: 700;
      }

      .ReportTable-wrapper {
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      thead {
        background: #f5f5f5;
      }

      th {
        padding: 16px;
        text-align: left;
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #e0e0e0;
      }

      td {
        padding: 16px;
        border-bottom: 1px solid #f0f0f0;
        font-size: 14px;
      }

      tbody tr:hover {
        background: #f9f9f9;
      }

      .positive-value {
        color: #2E7D32;
        font-weight: 600;
      }

      .negative-value {
        color: #d32f2f;
        font-weight: 600;
      }

      .ReportCharts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
      }

      .chart-ReportContainer {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }

      .chart-ReportContainer h3 {
        margin: 0 0 20px 0;
        font-size: 18px;
        font-weight: 700;
      }

      .ReportChart-wrapper {
        position: relative;
        height: 300px;
      }

      .investor-details {
        font-size: 12px;
        color: #666;
      }

      .investor-badge {
        display: inline-block;
        padding: 4px 8px;
        background: #e8f5e9;
        border-radius: 4px;
        margin-right: 4px;
        margin-bottom: 4px;
        font-size: 11px;
        font-weight: 600;
      }

      @media (max-width: 768px) {
        .ReportContainer {
          padding: 16px;
        }

        .ReportHeader h1 {
          font-size: 24px;
        }

        .ReportStats-grid {
          grid-template-columns: 1fr;
        }

        .ReportCharts-grid {
          grid-template-columns: 1fr;
        }

        .ReportFilters {
          flex-direction: column;
        }

        th, td {
          padding: 12px 8px;
          font-size: 12px;
        }
      }
    `;

      const styleSheet = document.createElement("style");
      styleSheet.textContent = styles;
      document.head.appendChild(styleSheet);

      const laporanData = [
        {
          komoditas: "Padi",
          totalBiaya: 4500000,
          totalHasil: 7500000,
          labaRugi: 3000000,
          efisiensi: 88,
          investor: [
            { nama: "Investor A", persen: 40 },
            { nama: "Investor B", persen: 30 },
            { nama: "Petani", persen: 30 },
          ],
        },
        {
          komoditas: "Cabai",
          totalBiaya: 2500000,
          totalHasil: 2000000,
          labaRugi: -500000,
          efisiensi: 60,
          investor: [
            { nama: "Investor A", persen: 50 },
            { nama: "Petani", persen: 50 },
          ],
        },
        {
          komoditas: "Jagung",
          totalBiaya: 3000000,
          totalHasil: 5000000,
          labaRugi: 2000000,
          efisiensi: 80,
          investor: [
            { nama: "Investor B", persen: 60 },
            { nama: "Petani", persen: 40 },
          ],
        },
      ];

      const ReportDefaultConfig = {
        dashboard_title: "Laporan Data Akhir Pertanian",
        ReportSubtitle: "Dashboard Monitoring & Analisis",
        primary_color: "#2E7D32",
        secondary_color: "#FFA726",
        background_color: "#f5f7fa",
        text_color: "#333333",
        font_family: "Segoe UI",
      };

      let config = { ...ReportDefaultConfig };
      let barChart, pieChart, lineChart;
      let currentKomoditasFilter = "semua";

      function formatCurrency(value) {
        return new Intl.NumberFormat("id-ID", {
          style: "currency",
          currency: "IDR",
          minimumFractionDigits: 0,
        }).format(value);
      }

      function getFilteredData() {
        let filtered = [...laporanData];

        if (currentKomoditasFilter !== "semua") {
          filtered = filtered.filter(
            (item) => item.komoditas === currentKomoditasFilter
          );
        }

        return filtered;
      }

      function calculateStats() {
        const data = getFilteredData();
        const totalPemasukan = data.reduce(
          (sum, item) => sum + item.totalHasil,
          0
        );
        const totalPengeluaran = data.reduce(
          (sum, item) => sum + item.totalBiaya,
          0
        );
        const totalLabaRugi = data.reduce(
          (sum, item) => sum + item.labaRugi,
          0
        );
        const avgEfisiensi =
          data.reduce((sum, item) => sum + item.efisiensi, 0) / data.length;

        const allInvestors = new Set();
        data.forEach((item) => {
          item.investor.forEach((inv) => allInvestors.add(inv.nama));
        });

        return {
          totalPemasukan,
          totalPengeluaran,
          totalLabaRugi,
          avgEfisiensi: avgEfisiensi.toFixed(1),
          jumlahInvestor: allInvestors.size,
        };
      }

      function renderStats() {
        const stats = calculateStats();
        const statsGrid = document.getElementById("ReportStats-grid");

        statsGrid.innerHTML = `
        <div class="stat-card positive">
          <h3>Total Pemasukan</h3>
          <p class="value">${formatCurrency(stats.totalPemasukan)}</p>
        </div>
        <div class="stat-card negative">
          <h3>Total Pengeluaran</h3>
          <p class="value">${formatCurrency(stats.totalPengeluaran)}</p>
        </div>
        <div class="stat-card ${
          stats.totalLabaRugi >= 0 ? "positive" : "negative"
        }">
          <h3>Total Laba/Rugi</h3>
          <p class="value">${formatCurrency(stats.totalLabaRugi)}</p>
        </div>
        <div class="stat-card neutral">
          <h3>Efisiensi Panen</h3>
          <p class="value">${stats.avgEfisiensi}%</p>
        </div>
        <div class="stat-card neutral">
          <h3>Jumlah Investor</h3>
          <p class="value">${stats.jumlahInvestor}</p>
        </div>
      `;
      }

      function renderTable() {
        const data = getFilteredData();
        const tbody = document.getElementById("ReportTable-body");
        tbody.innerHTML = "";

        data.forEach((item) => {
          item.investor.forEach((inv, index) => {
            const nilaiBagiHasil = (inv.persen / 100) * item.labaRugi;
            const row = document.createElement("tr");

            row.innerHTML = `
            <td>${index === 0 ? item.komoditas : ""}</td>
            <td>${index === 0 ? formatCurrency(item.totalBiaya) : ""}</td>
            <td>${index === 0 ? formatCurrency(item.totalHasil) : ""}</td>
            <td class="${
              item.labaRugi >= 0 ? "positive-value" : "negative-value"
            }">
              ${index === 0 ? formatCurrency(item.labaRugi) : ""}
            </td>
            <td>${index === 0 ? item.efisiensi + "%" : ""}</td>
            <td><span class="investor-badge">${inv.nama}</span></td>
            <td>${inv.persen}%</td>
            <td class="${
              nilaiBagiHasil >= 0 ? "positive-value" : "negative-value"
            }">
              ${formatCurrency(nilaiBagiHasil)}
            </td>
          `;

            tbody.appendChild(row);
          });
        });
      }

      function renderBarChart() {
        const data = getFilteredData();
        const ctx = document.getElementById("ReportBar-chart").getContext("2d");

        if (barChart) {
          barChart.destroy();
        }

        barChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: data.map((item) => item.komoditas),
            datasets: [
              {
                label: "Total Biaya",
                data: data.map((item) => item.totalBiaya),
                backgroundColor:
                  config.secondary_color || ReportDefaultConfig.secondary_color,
                borderRadius: 8,
              },
              {
                label: "Total Hasil",
                data: data.map((item) => item.totalHasil),
                backgroundColor:
                  config.primary_color || ReportDefaultConfig.primary_color,
                borderRadius: 8,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function (value) {
                    return "Rp " + (value / 1000000).toFixed(1) + "jt";
                  },
                },
              },
            },
          },
        });
      }

      function renderPieChart() {
        const data = getFilteredData();
        const ctx = document.getElementById("ReportPie-chart").getContext("2d");

        if (pieChart) {
          pieChart.destroy();
        }

        const investorTotals = {};
        data.forEach((item) => {
          if (item.labaRugi > 0) {
            item.investor.forEach((inv) => {
              const nilai = (inv.persen / 100) * item.labaRugi;
              investorTotals[inv.nama] =
                (investorTotals[inv.nama] || 0) + nilai;
            });
          }
        });

        const colors = [
          config.primary_color || ReportDefaultConfig.primary_color,
          config.secondary_color || ReportDefaultConfig.secondary_color,
          "#66BB6A",
          "#FFB74D",
          "#4FC3F7",
        ];

        pieChart = new Chart(ctx, {
          type: "pie",
          data: {
            labels: Object.keys(investorTotals),
            datasets: [
              {
                data: Object.values(investorTotals),
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: "#fff",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    return (
                      context.label + ": " + formatCurrency(context.parsed)
                    );
                  },
                },
              },
            },
          },
        });
      }

      function renderLineChart() {
        const data = getFilteredData();
        const ctx = document
          .getElementById("ReportLine-chart")
          .getContext("2d");

        if (lineChart) {
          lineChart.destroy();
        }

        const colors = [
          config.primary_color || ReportDefaultConfig.primary_color,
          config.secondary_color || ReportDefaultConfig.secondary_color,
          "#66BB6A",
        ];

        const datasets = data.map((item, index) => ({
          label: item.komoditas,
          data: [0, item.labaRugi * 0.3, item.labaRugi * 0.6, item.labaRugi],
          borderColor: colors[index % colors.length],
          backgroundColor: colors[index % colors.length] + "20",
          tension: 0.4,
          fill: true,
          pointRadius: 5,
          pointHoverRadius: 7,
        }));

        lineChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: ["Awal", "Bulan 1", "Bulan 2", "Akhir"],
            datasets: datasets,
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
              },
            },
            scales: {
              y: {
                ticks: {
                  callback: function (value) {
                    return formatCurrency(value);
                  },
                },
              },
            },
          },
        });
      }

      function ReportFopulateFilters() {
        const komoditasFilter = document.getElementById(
          "ReportKomoditas-filter"
        );

        const komoditasSet = new Set(laporanData.map((item) => item.komoditas));
        komoditasSet.forEach((komoditas) => {
          const option = document.createElement("option");
          option.value = komoditas;
          option.textContent = komoditas;
          komoditasFilter.appendChild(option);
        });
      }

      function updateDisplay() {
        renderStats();
        renderTable();
        renderBarChart();
        renderPieChart();
        renderLineChart();
        applyColors();
      }

      function applyColors() {
        const primaryColor =
          config.primary_color || ReportDefaultConfig.primary_color;
        const secondaryColor =
          config.secondary_color || ReportDefaultConfig.secondary_color;
        const textColor = config.text_color || ReportDefaultConfig.text_color;
        const fontFamily =
          config.font_family || ReportDefaultConfig.font_family;

        document.body.style.fontFamily = `${fontFamily}, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif`;
        document.body.style.color = textColor;

        document.getElementById("ReportDashboard-title").style.color =
          primaryColor;

        const statCards = document.querySelectorAll(
          ".stat-card.positive .value"
        );
        statCards.forEach((card) => {
          card.style.color = primaryColor;
        });

        const neutralCards = document.querySelectorAll(
          ".stat-card.neutral .value"
        );
        neutralCards.forEach((card) => {
          card.style.color = secondaryColor;
        });

        const selectElements = document.querySelectorAll("select");
        selectElements.forEach((select) => {
          select.addEventListener("focus", function () {
            this.style.borderColor = primaryColor;
          });
        });
      }

      document
        .getElementById("ReportKomoditas-filter")
        .addEventListener("change", (e) => {
          currentKomoditasFilter = e.target.value;
          updateDisplay();
        });

      async function onConfigChange(newConfig) {
        config = { ...config, ...newConfig };

        document.getElementById("ReportDashboard-title").textContent =
          config.dashboard_title || ReportDefaultConfig.dashboard_title;
        document.getElementById("ReportSubtitle").textContent =
          config.ReportSubtitle || ReportDefaultConfig.ReportSubtitle;

        updateDisplay();
      }

      if (window.elementSdk) {
        window.elementSdk.init({
          ReportDefaultConfig,
          onConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () =>
                  config.primary_color || ReportDefaultConfig.primary_color,
                set: (value) => {
                  config.primary_color = value;
                  window.elementSdk.setConfig({ primary_color: value });
                },
              },
              {
                get: () =>
                  config.secondary_color || ReportDefaultConfig.secondary_color,
                set: (value) => {
                  config.secondary_color = value;
                  window.elementSdk.setConfig({ secondary_color: value });
                },
              },
              {
                get: () => config.text_color || ReportDefaultConfig.text_color,
                set: (value) => {
                  config.text_color = value;
                  window.elementSdk.setConfig({ text_color: value });
                },
              },
            ],
            borderables: [],
            fontEditable: {
              get: () => config.font_family || ReportDefaultConfig.font_family,
              set: (value) => {
                config.font_family = value;
                window.elementSdk.setConfig({ font_family: value });
              },
            },
            fontSizeable: undefined,
          }),
          mapToEditPanelValues: (config) =>
            new Map([
              [
                "dashboard_title",
                config.dashboard_title || ReportDefaultConfig.dashboard_title,
              ],
              [
                "ReportSubtitle",
                config.ReportSubtitle || ReportDefaultConfig.ReportSubtitle,
              ],
            ]),
        });
      }

      ReportFopulateFilters();
      updateDisplay();
    </script>
  </body>
</html>
